{% extends 'base.html' %}
{% load static %}

{% block title %}Resultados de Búsqueda Global{% endblock %}

{% block extra_head %}
<style>
  :root{
    --adr-primary:#9e0909;
    --adr-primary-dark:#7f0707;
  }

  /* --- Encabezado de la card en rojo --- */
  .card-header.card-header-adr{
    background: var(--adr-primary) !important;
    color:#fff !important;
    border-radius:12px 12px 0 0;
    border:0;
  }

  /* --- Chip contador en rojo --- */
  .count-chip{
    background: var(--adr-primary) !important;
    color:#fff !important;
    font-weight:700;
    padding:.25rem .6rem;
    border-radius:999px;
    border:1px solid var(--adr-primary-dark);
    line-height:1;
  }

  /* --- Thead totalmente rojo --- */
  .table>thead>tr>th{
    background-color: var(--adr-primary) !important;
    color:#fff !important;
    text-align:center;
    border:1px solid #fff !important;
    position:sticky;
    top:0;
    z-index:2;
  }

  /* Botón Buscar rojo (si lo ocupas con class="btn-search") */
  .btn-search{
    background:var(--adr-primary) !important;
    color:#fff !important;
    border:none !important;
    font-weight:600;
  }
  .btn-search:hover{ background:var(--adr-primary-dark) !important; }

  /* texto con elipsis en celdas */
  .td-trunc{
    display:inline-block;
    max-width:220px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    vertical-align:bottom;
  }
  .font-mono{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing:.2px;
  }

  /* ancho para la columna Acciones */
  th.actions-col, td.actions-col{ white-space:nowrap; width:100px; }

  /* --- Botón copiar --- */
  .copy-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:9999px;
    background:#f3f4f6; border:1px solid #e5e7eb;
    color:#374151; cursor:pointer; transition:all .15s ease;
  }
  .copy-btn:hover{ background:#e5e7eb; }
  .copy-btn.copied{ transform:scale(.93); }

  /* --- Mini toast --- */
  .copy-toast{
    position:fixed; right:24px; bottom:24px;
    background:#111827; color:#fff; padding:8px 12px;
    border-radius:9999px; box-shadow:0 10px 25px rgba(0,0,0,.25);
    opacity:0; transform:translateY(8px); transition:all .25s ease;
    pointer-events:none; z-index:9999;
  }
  .copy-toast.show{ opacity:1; transform:translateY(0); }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mt-md-5">

  <!-- Barra de búsqueda única -->
  <div class="buscadorContainer" style="margin: 20px auto; width: fit-content; text-align: center; border-radius: 10px; overflow: hidden; background: #f5f5f5; padding:15px;">
    <form onsubmit="submitSearch(event)" style="display: inline-flex; gap: 10px;">
      <input type="text" id="search" name="q" placeholder="Escanea o escribe código/nombre"
             style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ccc;"
             value="{{ query|default_if_none:'' }}">
      <button type="submit"
              style="padding: 10px 20px; border-radius: 5px; border: none; background-color: #9e0909; color: #fff; cursor:pointer;">
        Buscar
      </button>
    </form>
  </div>

  {% if resultados_por_modelo %}
    {% for item in resultados_por_modelo %}
      {% if item.resultados %}
      <div class="card mb-4 shadow-sm">
        <div class="card-header card-header-adr d-flex justify-content-between align-items-center px-3 px-md-4">
          <h3 class="h5 mb-0">{{ item.nombre_plural }}</h3>
          <span class="count-chip">{{ item.resultados|length }}</span>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>Activo</th>
                  <th>Estado</th>
                  <th>Marca</th>
                  <th>Modelo</th>
                  <th>N° Serie</th>
                  <th>UNIVE</th>
                  <th>BDO</th>
                  <th>NetBios</th>
                  <th>Ubicación</th>
                  <th>Registrado por</th>
                  <th>Fecha Creación</th>
                  <th>Fecha Modificación</th>
                  {% if item.modelo_name == "Notebook" %}<th>Asignado a</th>{% endif %}
                  <th class="text-end actions-col">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for r in item.resultados %}
                <tr>
                  <td class="td-trunc">{{ r.activo|default_if_none:""|capfirst }}</td>

                  <td>
                    {% with r.estado as est %}
                      <span class="badge {% if est == 'Activo' or est == 'Operativo' %}bg-success
                                         {% elif est == 'En reparación' %}bg-warning text-dark
                                         {% elif est == 'De baja' %}bg-danger
                                         {% else %}bg-secondary{% endif %}">
                        {{ est|default_if_none:""|capfirst }}
                      </span>
                    {% endwith %}
                  </td>

                  <td>{{ r.marca|default_if_none:""|capfirst }}</td>
                  <td class="td-trunc">{{ r.modelo|default_if_none:""|capfirst }}</td>

                  <!-- N° Serie con copiar -->
                  <td class="font-mono">
                    <div class="flex items-center gap-1">
                      <span class="td-trunc">{{ r.n_serie|default_if_none:"" }}</span>
                      {% if r.n_serie %}
                      <button type="button"
                              class="copy-btn js-copy"
                              data-copy="{{ r.n_serie|default_if_none:''|escape }}"
                              title="Copiar N° de serie" aria-label="Copiar N° de serie">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                          <path d="M5 15V5a2 2 0 0 1 2-2h10"></path>
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                  </td>

                  <!-- UNIVE con copiar -->
                  <td class="font-mono">
                    <div class="flex items-center gap-1">
                      <span class="td-trunc">{{ r.unive|default_if_none:"" }}</span>
                      {% if r.unive %}
                      <button type="button"
                              class="copy-btn js-copy"
                              data-copy="{{ r.unive|default_if_none:''|escape }}"
                              title="Copiar UNIVE" aria-label="Copiar UNIVE">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                          <path d="M5 15V5a2 2 0 0 1 2-2h10"></path>
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                  </td>

                  <!-- BDO (sin copiar, como pediste) -->
                  <td>{{ r.bdo|default_if_none:"" }}</td>

                  <!-- NetBios con copiar -->
                  <td class="font-mono">
                    <div class="flex items-center gap-1">
                      <span class="td-trunc">{{ r.netbios|default_if_none:"" }}</span>
                      {% if r.netbios %}
                      <button type="button"
                              class="copy-btn js-copy"
                              data-copy="{{ r.netbios|default_if_none:''|escape }}"
                              title="Copiar NetBios" aria-label="Copiar NetBios">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                          <path d="M5 15V5a2 2 0 0 1 2-2h10"></path>
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                  </td>

                  <td class="td-trunc">{{ r.ubicacion|default_if_none:""|capfirst }}</td>
                  <td class="td-trunc">{{ r.registrado_por|default_if_none:"" }}</td>
                  <td class="font-mono">{{ r.fecha_creacion|date:"Y-m-d H:i" }}</td>
                  <td class="font-mono">{{ r.fecha_modificacion|date:"Y-m-d H:i" }}</td>

                  {% if item.modelo_name == "Notebook" or item.modelo_name == "Monitor" %}
                  <td class="td-trunc">{{ r.asignado_a|default_if_none:""|capfirst }}</td>
                  {% endif %}

                  <!-- Acciones -->
                  <td class="text-end actions-col">
                    <div class="flex items-center gap-1 justify-end">
                      <!-- Ver (azul) -->
                      <a href="{% url 'detalle_activo_busqueda' model_name=item.modelo_name|lower pk=r.pk %}?q={{ query|urlencode }}"
                         class="inline-flex items-center justify-center w-8 h-8 rounded-full text-white
                                bg-gradient-to-br from-blue-500 to-blue-700
                                hover:from-blue-600 hover:to-blue-800 shadow-md"
                         title="Ver" aria-label="Ver">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/>
                          <circle cx="12" cy="12" r="3" />
                        </svg>
                      </a>

                      <!-- Modificar (ámbar) -->
                      {% if item.modelo_name|lower == 'allinone' %}
                        <a href="{% url 'edit_all_in_one' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'allinoneadmins' %}
                        <a href="{% url 'edit_all_in_one_adm' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'notebook' %}
                        <a href="{% url 'edit_notebook' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'minipc' %}
                        <a href="{% url 'edit_mini_pc' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'proyectores' %}
                        <a href="{% url 'edit_proyector' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'bodegaadr' %}
                        <a href="{% url 'edit_bodega_adr' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'azotea' %}
                        <a href="{% url 'edit_azotea_adr' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'monitor' %}
                        <a href="{% url 'edit_monitor' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'audio' %}
                        <a href="{% url 'edit_audio' pk=r.pk %}"
                      {% elif item.modelo_name|lower == 'tablet' %}
                        <a href="{% url 'edit_tablet' pk=r.pk %}"
                      {% endif %}
                           class="inline-flex items-center justify-center w-8 h-8 rounded-full text-white
                                  bg-gradient-to-br from-amber-500 to-amber-700
                                  hover:from-amber-600 hover:to-amber-800 shadow-md"
                           title="Modificar" aria-label="Modificar">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536L9 18H5.5V14.5z"/>
                          </svg>
                        </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="alert alert-warning mt-4" role="alert">
      No se encontraron resultados para “{{ query }}”.
    </div>
  {% endif %}

  <div class="mt-3">
    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8.354 1.146a.5.5 0 0 0-.708 0L1 7.793V15.5a.5.5 0 0 0 .5.5H6v-4h4v4h4.5a.5.5 0 0 0 .5-.5V7.793l-6.646-6.647z"/>
      </svg>
      Volver al Home
    </a>
  </div>

  <!-- JS: copiar al portapapeles -->
  <script>
  (function () {
    // Toast reutilizable
    const toast = document.createElement('div');
    toast.className = 'copy-toast';
    document.body.appendChild(toast);
    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1200);
    };

    async function copyText(text) {
      if (!text) { showToast('Vacío'); return; }
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        showToast('Copiado');
      } catch (e) {
        showToast('No se pudo copiar');
      }
    }

    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('.js-copy');
      if (!btn) return;
      const value = btn.dataset.copy || '';
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 700);
      copyText(value.trim());
    });
  })();
  </script>
</div>
{% endblock %}
